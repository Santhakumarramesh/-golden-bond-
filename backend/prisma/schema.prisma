// Golden Bond - Database Schema
// PostgreSQL with Prisma ORM

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String
  role         UserRole  @default(USER)
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  profile      Profile?
  membership   UserMembership?
  sentMessages Message[] @relation("SentMessages")
  reports      Report[]  @relation("ReportedBy")
  chatSessions ChatbotSession[]

  @@index([email])
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  BLOCKED
  DELETED
  PENDING_VERIFICATION
}

// ============================================
// PROFILE
// ============================================

model Profile {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique
  profileCode     String    @unique @default(uuid()) // GB-2024-XXXXX

  // Basic Info
  firstName       String
  lastName        String?
  gender          Gender
  dob             DateTime
  height          String?   // e.g., "5'10" or "178cm"
  weight          String?
  bodyType        BodyType?
  complexion      String?
  physicalStatus  String?   @default("Normal")
  bloodGroup      String?

  // Marital Status
  maritalStatus   MaritalStatus

  // Religion & Community
  religion        String
  community       String?
  subCommunity    String?
  gotra           String?

  // Location
  country         String
  state           String?
  city            String?
  citizenship     String?
  residencyStatus String?
  visaStatus      String?

  // Languages
  motherTongue    String?
  languagesKnown  String[]  // Array of languages

  // Education & Career
  education       String?
  educationDetail String?
  college         String?
  profession      String?
  company         String?
  income          String?
  workingWith     String?   // Private, Government, Business, etc.

  // Lifestyle
  diet            Diet?
  smoking         Habit?
  drinking        Habit?
  pets            String?
  hobbies         String[]

  // Family Details
  familyType      FamilyType?
  familyStatus    String?
  familyValues    String?
  nativePlace     String?
  fatherName      String?
  fatherOccupation String?
  motherName      String?
  motherOccupation String?
  siblings        String?   // JSON or text description

  // Horoscope
  rashi           String?
  nakshatra       String?
  manglik         String?
  birthTime       String?
  birthPlace      String?
  kundliAvailable Boolean   @default(false)

  // Profile Content
  bio             String?   @db.Text
  aboutFamily     String?   @db.Text

  // Verification & Status
  verified        Boolean   @default(false)
  emailVerified   Boolean   @default(false)
  phoneVerified   Boolean   @default(false)
  idVerified      Boolean   @default(false)
  photoVerified   Boolean   @default(false)
  videoVerified   Boolean   @default(false)
  profileStatus   ProfileStatus @default(PENDING)
  trustScore      Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferences     Preference?
  photos          ProfilePhoto[]
  matchesAs1      Match[]   @relation("Profile1Matches")
  matchesAs2      Match[]   @relation("Profile2Matches")
  viewsReceived   ProfileView[] @relation("ViewedProfile")
  viewsGiven      ProfileView[] @relation("ViewerProfile")
  interestsSent   Interest[] @relation("InterestSender")
  interestsReceived Interest[] @relation("InterestReceiver")
  reportsAgainst  Report[]  @relation("ReportedProfile")

  @@index([gender])
  @@index([religion])
  @@index([country])
  @@index([maritalStatus])
  @@index([profileStatus])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  NEVER_MARRIED
  DIVORCED
  WIDOWED
  AWAITING_DIVORCE
  ANNULLED
}

enum BodyType {
  SLIM
  AVERAGE
  ATHLETIC
  HEAVY
}

enum Diet {
  VEGETARIAN
  NON_VEGETARIAN
  EGGETARIAN
  VEGAN
  JAIN
}

enum Habit {
  YES
  NO
  OCCASIONALLY
}

enum FamilyType {
  NUCLEAR
  JOINT
  OTHER
}

enum ProfileStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

// ============================================
// PARTNER PREFERENCES
// ============================================

model Preference {
  id              Int      @id @default(autoincrement())
  profileId       Int      @unique

  // Age
  ageMin          Int      @default(18)
  ageMax          Int      @default(60)

  // Height
  heightMin       String?
  heightMax       String?

  // Marital Status
  maritalStatusAllowed MaritalStatus[]

  // Religion & Community
  religionsAllowed String[]  // "Any" or specific religions
  communitiesAllowed String[]

  // Location
  countriesAllowed String[]
  statesAllowed    String[]

  // Education & Career
  educationAllowed String[]
  professionAllowed String[]
  incomeMin        String?

  // Lifestyle
  dietAllowed      Diet[]
  smokingAllowed   Habit[]
  drinkingAllowed  Habit[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  profile         Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

// ============================================
// PHOTOS
// ============================================

model ProfilePhoto {
  id          Int      @id @default(autoincrement())
  profileId   Int
  url         String
  blurredUrl  String?  // For non-premium users
  isPrimary   Boolean  @default(false)
  isApproved  Boolean  @default(false)
  createdAt   DateTime @default(now())

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

// ============================================
// MATCHES & INTERACTIONS
// ============================================

model Match {
  id          Int         @id @default(autoincrement())
  profile1Id  Int
  profile2Id  Int
  status      MatchStatus @default(PENDING)
  score       Int?        // Compatibility score 0-100
  breakdown   Json?       // Detailed score breakdown
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  profile1    Profile     @relation("Profile1Matches", fields: [profile1Id], references: [id], onDelete: Cascade)
  profile2    Profile     @relation("Profile2Matches", fields: [profile2Id], references: [id], onDelete: Cascade)
  messages    Message[]

  @@unique([profile1Id, profile2Id])
  @@index([profile1Id])
  @@index([profile2Id])
}

enum MatchStatus {
  PENDING
  MUTUAL
  REJECTED
  BLOCKED
}

model Interest {
  id          Int           @id @default(autoincrement())
  senderId    Int
  receiverId  Int
  status      InterestStatus @default(PENDING)
  message     String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  sender      Profile       @relation("InterestSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    Profile       @relation("InterestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
}

enum InterestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model ProfileView {
  id          Int      @id @default(autoincrement())
  viewerId    Int
  viewedId    Int
  viewedAt    DateTime @default(now())

  viewer      Profile  @relation("ViewerProfile", fields: [viewerId], references: [id], onDelete: Cascade)
  viewed      Profile  @relation("ViewedProfile", fields: [viewedId], references: [id], onDelete: Cascade)

  @@index([viewerId])
  @@index([viewedId])
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id          Int      @id @default(autoincrement())
  matchId     Int
  senderId    Int
  content     String   @db.Text
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  match       Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([senderId])
}

// ============================================
// MEMBERSHIP & PAYMENTS
// ============================================

model MembershipPlan {
  id           Int      @id @default(autoincrement())
  name         String   // Basic, Gold, Diamond, Elite
  slug         String   @unique
  price        Int      // In smallest currency unit (paise/cents)
  currency     String   @default("INR")
  durationDays Int
  features     Json     // Array of feature strings
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())

  memberships  UserMembership[]
}

model UserMembership {
  id          Int              @id @default(autoincrement())
  userId      Int              @unique
  planId      Int
  startDate   DateTime
  endDate     DateTime
  status      MembershipStatus @default(ACTIVE)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan        MembershipPlan   @relation(fields: [planId], references: [id])
  payments    Payment[]

  @@index([userId])
  @@index([status])
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

model Payment {
  id                Int           @id @default(autoincrement())
  membershipId      Int
  provider          String        // stripe, razorpay, paypal
  providerPaymentId String?
  amount            Int
  currency          String
  status            PaymentStatus @default(PENDING)
  metadata          Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  membership        UserMembership @relation(fields: [membershipId], references: [id])

  @@index([providerPaymentId])
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

// ============================================
// AI CHATBOT
// ============================================

model ChatbotSession {
  id           Int      @id @default(autoincrement())
  userId       Int?
  languageCode String   @default("en")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages     ChatbotMessage[]
}

model ChatbotMessage {
  id          Int      @id @default(autoincrement())
  sessionId   Int
  sender      String   // "user" or "bot"
  content     String   @db.Text
  createdAt   DateTime @default(now())

  session     ChatbotSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// ============================================
// REPORTS & MODERATION
// ============================================

model Report {
  id              Int          @id @default(autoincrement())
  reportedById    Int
  reportedProfileId Int
  reason          ReportReason
  details         String?      @db.Text
  status          ReportStatus @default(OPEN)
  adminNotes      String?      @db.Text
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  reportedBy      User         @relation("ReportedBy", fields: [reportedById], references: [id])
  reportedProfile Profile      @relation("ReportedProfile", fields: [reportedProfileId], references: [id])

  @@index([status])
}

enum ReportReason {
  FAKE_PROFILE
  INAPPROPRIATE_CONTENT
  HARASSMENT
  SPAM
  SCAM
  OTHER
}

enum ReportStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

